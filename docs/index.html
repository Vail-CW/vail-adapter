<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vail Adapter Firmware Update</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<nav>
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="https://vailadapter.com/assembly" target="_blank">Assembly Instructions</a></li>
    </ul>
</nav>

<div class="container">
    <h1>Vail Adapter Firmware Update</h1>

    <!-- Button Hat Warning (hidden until Adapter selected) -->
    <div id="buttonHatWarning" class="warning-box" style="display: none; background: linear-gradient(135deg, #4a3800 0%, #5c4a00 100%); border: 2px solid #ffc107; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
        <h3 style="margin-top: 0; color: #ffc107;">‚ö†Ô∏è Important: Vail Adapter Button Hat Hardware Modification Required</h3>
        <p style="margin-bottom: 10px; color: #e0e0e0;">If you have a <strong>Vail Adapter with Basic PCB V2 or Advanced PCB with Button Hat purchased in 2025</strong>, firmware dated <strong>November 11, 2025 or later</strong> requires a simple hardware modification to continue working.</p>
        <p style="margin-bottom: 15px; color: #e0e0e0;">This one-time modification involves adding a jumper wire from pin A3 to A8 and cutting the A3 header pin.</p>
        <a href="button-hat-mod.html" class="btn-primary" style="display: inline-block; text-decoration: none;">üìã View Modification Guide</a>
        <p style="margin-top: 10px; font-size: 14px; color: #ffda6a;"><strong>Note:</strong> This applies to Vail Adapter only (not Summit) and only button hats purchased in 2025. Button hats from 2026 onward will use updated PCBs and will not require this modification. If you don't have a button hat, you can ignore this warning and proceed with the update.</p>
    </div>

    <!-- What's New Section (hidden until device selected) -->
    <details class="whats-new" id="whatsNewSection" style="display: none;">
        <summary>
            <span class="expand-icon">‚ñ∂</span>
            <strong><span id="whatsNewDevice">Vail</span> Updates:</strong> <span id="lastUpdateDate">Loading...</span>
            <span class="click-hint">‚Äî Click to see what's new</span>
        </summary>
        <ul id="recentCommitsList">
            <li>Loading recent updates...</li>
        </ul>
        <p class="manual-link" id="manualLink">üìñ <a href="https://vailadapter.com/manual" target="_blank">View User Manual</a></p>
    </details>

    <!-- Progress Indicator -->
    <div class="progress-bar">
        <div class="progress-step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">Model</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">Board</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">Update</div>
        </div>
    </div>

    <!-- Step 1: Device Selection -->
    <section id="step1" class="wizard-step active">
        <h2>Which Vail device do you have?</h2>
        <p class="step-description">Choose your device type.</p>

        <div class="card-grid">
            <div class="selection-card" data-device="adapter">
                <div class="card-icon">üì°</div>
                <h3>Vail Adapter</h3>
                <p>USB adapter that connects paddles to your computer for web-based CW</p>
            </div>

            <div class="selection-card" data-device="summit">
                <div class="card-icon">‚õ∞Ô∏è</div>
                <h3>Vail Summit</h3>
                <p>Standalone morse code trainer with built-in screen and keyboard</p>
            </div>
        </div>
    </section>

    <!-- Step 1.5: Adapter Model Selection (only shown for Adapter) -->
    <section id="step1_5" class="wizard-step">
        <h2>What model of Vail Adapter do you have?</h2>
        <p class="step-description">Choose the PCB version that matches your adapter.</p>

        <div class="card-grid">
            <div class="selection-card" data-model="basic_pcb">
                <div class="card-icon">üéõÔ∏è</div>
                <h3>Basic PCB</h3>
                <p>Standard Vail Adapter PCB with paddle inputs and sidetone</p>
            </div>

            <div class="selection-card" data-model="advanced_pcb">
                <div class="card-icon">‚ö°</div>
                <h3>Advanced PCB</h3>
                <p>Includes radio output port and built-in capacitive touch points</p>
            </div>

            <div class="selection-card" data-model="vail_lite">
                <div class="card-icon">ü™∂</div>
                <h3>Vail Lite</h3>
                <p>USB stick form factor with buzzer sidetone only - no buttons, capacitive touch, headphone jack, or radio output</p>
            </div>

            <div class="selection-card" data-model="non_pcb">
                <div class="card-icon">üîß</div>
                <h3>DIY No PCB</h3>
                <p>Hand-wired or breadboard build following GitHub specs</p>
            </div>
        </div>

        <button class="btn-secondary" id="backToStep1FromModel">‚Üê Back</button>
    </section>

    <!-- Step 2: Board Selection -->
    <section id="step2" class="wizard-step">
        <h2>Which Arduino board are you using?</h2>
        <p class="step-description">Select the microcontroller on your adapter.</p>

        <div class="card-grid">
            <div class="selection-card" data-board="qtpy">
                <div class="card-icon">üî∑</div>
                <h3>Adafruit QT Py SAMD21</h3>
                <p>Look for "QT Py" labeling on the board</p>
                <div class="hint" id="qtpyHint">üí° Most purchased Adapters will likely be a QT Py when in doubt</div>
            </div>

            <div class="selection-card" data-board="xiao">
                <div class="card-icon">üî∂</div>
                <h3>Seeeduino XIAO SAMD21</h3>
                <p>Look for "XIAO" labeling on the board</p>
            </div>
        </div>

        <button class="btn-secondary" id="backToStep1">‚Üê Back</button>
    </section>

    <!-- Step 3: Flash Adapter Firmware (UF2) -->
    <section id="step3" class="wizard-step">
        <h2>Flash Your Firmware</h2>
        <p class="step-description">You've selected: <strong id="selectedConfig"></strong></p>

        <!-- Sub-step 1: Plug In -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">1</span>
                <h3>Plug In Your Adapter</h3>
            </div>
            <p>Use a USB-C cable (must support data transfer) and connect your Vail Adapter to your computer.</p>
        </div>

        <!-- Sub-step 2: Enter Boot Mode -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">2</span>
                <h3>Enter Boot Mode</h3>
            </div>
            <p>Choose one of these methods to put your adapter into bootloader mode:</p>

            <div class="boot-methods">
                <div class="boot-method">
                    <h4>Method 1: WebSerial (Recommended)</h4>
                    <p>Click the button below to automatically trigger boot mode. Works in Chrome, Edge, and Opera browsers.</p>
                    <button id="bootModeButton" class="btn-primary">üîå Enter Boot Mode via WebSerial</button>
                    <div class="log-container">
                        <h4>Activity Log:</h4>
                        <pre id="serialLog"></pre>
                    </div>
                </div>

                <div class="boot-method">
                    <h4>Method 2: Manual Reset (Double-tap)</h4>
                    <p>Quickly double-tap the reset button on your adapter. The board should appear as a USB storage device (e.g., "QTPYBOOT" or "XIAOBOOT").</p>
                </div>
            </div>
        </div>

        <!-- Sub-step 3: Download Firmware -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">3</span>
                <h3>Download Firmware</h3>
            </div>
            <p>Download the firmware file for your configuration:</p>
            <a href="#" id="downloadButton" class="btn-download disabled" role="button" aria-disabled="true">
                <span class="download-icon">‚¨áÔ∏è</span>
                <span id="downloadText">Download UF2 File</span>
            </a>
        </div>

        <!-- Sub-step 4: Copy to Device -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">4</span>
                <h3>Copy Firmware to Device</h3>
            </div>
            <ol>
                <li>Open your file explorer (Finder on Mac, File Explorer on Windows)</li>
                <li>Find your Downloads folder and locate the downloaded .uf2 file</li>
                <li>Look for the adapter drive (named "QTPYBOOT", "XIAOBOOT", "ADAPTERBOOT", or similar)</li>
                <li>Drag and drop the .uf2 file onto the adapter drive</li>
                <li>Wait for the LED to stop flashing - the drive will automatically disconnect when complete</li>
            </ol>
        </div>

        <!-- Sub-step 5: Finalize -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">5</span>
                <h3>Finalize Setup</h3>
            </div>
            <ol>
                <li>Wait 10 seconds after the firmware copies</li>
                <li>Unplug and reconnect your Vail Adapter</li>
                <li><strong>Important:</strong> Visit <a href="https://vailmorse.com" target="_blank">vailmorse.com</a> (the official Vail web repeater) to configure your keyer type, speed, and tone settings</li>
                <li>Your settings will be saved to the device and can be used with any compatible CW application</li>
            </ol>
            <div class="success-message">
                <strong>‚úÖ You're all set!</strong> Your Vail Adapter is now running the latest firmware.
            </div>
        </div>

        <!-- Troubleshooting -->
        <div class="troubleshooting">
            <h3>‚ùì Troubleshooting</h3>
            <details>
                <summary>Device doesn't appear as storage drive</summary>
                <p>Try these steps:</p>
                <ul>
                    <li>Try the double-tap reset method instead of WebSerial</li>
                    <li>Use a different USB-C cable (some cables are charge-only)</li>
                    <li>Try a different USB port on your computer</li>
                    <li>Wait 5 seconds between taps when double-tapping the reset button</li>
                </ul>
            </details>

            <details>
                <summary>WebSerial button doesn't work</summary>
                <p>WebSerial requires Chrome, Edge, or Opera browser. If you're using Firefox or Safari, please switch browsers or use the manual reset method.</p>
            </details>

            <details>
                <summary>Linux: Permission denied</summary>
                <p>Add your user to the dialout group: <code>sudo usermod -a -G dialout $USER</code> then log out and back in.</p>
            </details>
        </div>

        <button class="btn-secondary" id="backToStep2">‚Üê Back</button>
        <button class="btn-primary" id="startOver">Start Over</button>
    </section>

    <!-- Step 4: Flash Summit Firmware (ESP32 Web Flasher) -->
    <section id="step4" class="wizard-step">
        <h2>Flash Vail Summit Firmware</h2>
        <p class="step-description">Web-based ESP32 flasher for the Vail Summit</p>

        <!-- Version Selection -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">1</span>
                <h3>Select Firmware Version</h3>
            </div>
            <p>Choose which firmware version to flash. The latest stable release is selected by default.</p>

            <div class="version-selector-container">
                <div class="version-selector-row">
                    <select id="versionSelect" class="version-select" disabled>
                        <option value="">Loading releases...</option>
                    </select>
                    <label class="test-release-toggle">
                        <input type="checkbox" id="showTestRelease">
                        <span class="toggle-label">Show test release</span>
                    </label>
                </div>

                <div id="testReleaseWarning" class="test-release-warning" style="display: none;">
                    <strong>Warning:</strong> Test releases may not be stable and could contain bugs. They include features currently being developed. Use at your own risk.
                </div>

                <div id="releaseInfo" class="release-info" style="display: none;">
                    <div class="release-info-header">
                        <span id="releaseVersionBadge" class="firmware-version"></span>
                        <span id="releaseDateDisplay" class="release-date"></span>
                    </div>
                    <div id="releaseNotes" class="release-notes"></div>
                </div>
            </div>
        </div>

        <!-- Flash Instructions -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">2</span>
                <h3>Connect Your Device</h3>
            </div>
            <p>Make sure your Vail Summit is plugged in via USB-C.</p>
        </div>

        <!-- ESP32 Flash Interface -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">3</span>
                <h3>Flash Firmware</h3>
            </div>

            <div id="espFlasherContainer">
                <!-- Primary Method: Automatic Connection -->
                <div class="auto-flash-section">
                    <p style="margin-bottom: 1rem;">Click the button below to connect to your Summit. The flasher will automatically enter bootloader mode and show flash options.</p>
                    <button id="enterBootloaderButton" class="btn-primary highlight-button">üîå Connect to Summit</button>
                </div>

                <!-- Fallback: Manual Bootloader Entry -->
                <details class="manual-fallback" style="margin-top: 1.5rem;">
                    <summary style="cursor: pointer; color: #ffc107; font-weight: 500;">‚ö†Ô∏è Connection not working? Try manual bootloader entry</summary>
                    <div class="manual-bootloader-instructions" style="padding: 1rem; margin-top: 0.5rem; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border: 1px solid rgba(255, 193, 7, 0.3);">
                        <p style="margin: 0 0 1rem; color: #ccc;">If automatic connection fails (e.g., "port in use" error), manually enter bootloader mode:</p>
                        <ol style="margin: 0 0 1rem; padding-left: 1.5rem;">
                            <li>Hold down the <strong>BOOT</strong> button on your Summit</li>
                            <li>While holding BOOT, press and release <strong>RESET</strong></li>
                            <li>Release the <strong>BOOT</strong> button</li>
                            <li>Your device will now show as "USB JTAG/Serial" instead of "TinyUSB CDC"</li>
                        </ol>
                        <button id="directConnectButton" class="btn-warning">I'm in Bootloader Mode - Connect</button>
                    </div>
                </details>
                <button id="connectButton" class="btn-primary" style="display: none;">Connect and Flash</button>
                <button id="disconnectButton" class="btn-secondary" style="display: none;">Disconnect</button>
                <button id="programButton" class="btn-download" style="display: none;">Flash Firmware</button>
                <button id="eraseAndFlashButton" class="btn-warning" style="display: none;">Full Erase & Flash (Recommended for USB issues)</button>
                <button id="eraseButton" class="btn-secondary" style="display: none;">Erase Only</button>

                <div class="progress-container" id="progressContainer" style="display: none; margin-top: 20px;">
                    <div class="progress-label" id="progressLabel">Preparing...</div>
                    <div style="background: #e0e0e0; border-radius: 8px; overflow: hidden; height: 24px;">
                        <div id="progressBar" style="background: linear-gradient(90deg, #4CAF50, #45a049); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="progressPercent" style="margin-top: 8px; font-size: 14px; color: #666;">0%</div>
                </div>

                <div class="log-container" style="margin-top: 20px;">
                    <h4>Flash Log:</h4>
                    <pre id="espFlashLog"></pre>
                </div>
            </div>
        </div>

        <!-- Finalize -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">4</span>
                <h3>Complete!</h3>
            </div>
            <p>Once flashing is complete, your device will automatically restart with the new firmware. If it doesn't restart automatically:</p>
            <ol>
                <li><strong>Unplug</strong> your Vail Summit from USB</li>
                <li><strong>Wait 2 seconds</strong></li>
                <li><strong>Plug it back in</strong> to power it on</li>
                <li>Follow the on-screen setup wizard to configure WiFi and preferences</li>
            </ol>
            <div class="success-message">
                <strong>‚úÖ You're all set!</strong> Your Vail Summit is ready for morse code training.
            </div>
        </div>

        <!-- Troubleshooting -->
        <div class="troubleshooting">
            <h3>‚ùì Troubleshooting</h3>
            <details>
                <summary>Browser doesn't support Web Serial</summary>
                <p>Web Serial API is required for ESP32 flashing. Please use Chrome, Edge, or Opera browser. Firefox and Safari are not currently supported.</p>
            </details>

            <details>
                <summary>"Port in use" or "Cannot access COM port" error</summary>
                <p>This is common on Windows. Try these solutions:</p>
                <ol>
                    <li><strong>Use manual bootloader entry:</strong> Expand the yellow section above and follow the BOOT + RESET instructions.</li>
                    <li><strong>Close other programs:</strong> Make sure Arduino IDE, PuTTY, or any other serial terminal is completely closed.</li>
                    <li><strong>Windows Device Manager fix:</strong>
                        <ul>
                            <li>Open Device Manager (Win+X ‚Üí Device Manager)</li>
                            <li>Find the COM port under "Ports (COM & LPT)"</li>
                            <li>Right-click ‚Üí Disable device, wait 2 seconds</li>
                            <li>Right-click ‚Üí Enable device</li>
                            <li>Try flashing again</li>
                        </ul>
                    </li>
                    <li><strong>Try a different USB port</strong> - preferably a USB 2.0 port if available.</li>
                </ol>
            </details>

            <details>
                <summary>Device shows as "TinyUSB CDC" but won't connect</summary>
                <p>Some devices use TinyUSB which doesn't support automatic bootloader entry. Use manual bootloader entry:</p>
                <ol>
                    <li>Hold down the <strong>BOOT</strong> button</li>
                    <li>While holding BOOT, press and release <strong>RESET</strong></li>
                    <li>Release the BOOT button</li>
                    <li>Device will now show as "USB JTAG/Serial"</li>
                    <li>Click "I'm in Bootloader Mode - Connect Now"</li>
                </ol>
            </details>

            <details>
                <summary>Flashing failed or stuck</summary>
                <p>If flashing fails:</p>
                <ul>
                    <li>Unplug the device, wait 5 seconds, and reconnect</li>
                    <li>Try manual bootloader entry (BOOT + RESET)</li>
                    <li>Try a different USB cable (some cables are charge-only)</li>
                </ul>
            </details>
        </div>

        <button class="btn-secondary" id="backToStep1FromSummit">‚Üê Back</button>
        <button class="btn-primary" id="startOverFromSummit">Start Over</button>
    </section>
</div>

<script src="esp-flasher.js" type="module"></script>
<script src="script.js" defer></script>
</body>
</html>
