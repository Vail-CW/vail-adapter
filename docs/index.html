<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vail Adapter Firmware Update</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<nav>
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="https://vailadapter.com/assembly" target="_blank">Assembly Instructions</a></li>
    </ul>
</nav>

<div class="container">
    <h1>Vail Adapter Firmware Update</h1>

    <!-- What's New Section -->
    <details class="whats-new">
        <summary>
            <span class="expand-icon">‚ñ∂</span>
            <strong>Last Update:</strong> Oct 26, 2025
            <span class="click-hint">‚Äî Click to see what's new</span>
        </summary>
        <ul>
            <li><strong>CW Memory Recording:</strong> Record and playback CW sequences (3 slots, 25 seconds each)</li>
            <li><strong>Double-click Detection:</strong> Start recording with a double-click gesture</li>
            <li><strong>Improved Button Controls:</strong> Enhanced menu navigation and state management</li>
            <li><strong>Bug Fixes:</strong> Resolved state transition issues in memory management mode</li>
        </ul>
        <p class="manual-link">üìñ <a href="https://vailadapter.com/manual" target="_blank">View User Manual</a></p>
    </details>

    <!-- Progress Indicator -->
    <div class="progress-bar">
        <div class="progress-step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">Model</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">Board</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">Update</div>
        </div>
    </div>

    <!-- Step 1: Device Selection -->
    <section id="step1" class="wizard-step active">
        <h2>Which Vail device do you have?</h2>
        <p class="step-description">Choose your device type.</p>

        <div class="card-grid">
            <div class="selection-card" data-device="adapter">
                <div class="card-icon">üì°</div>
                <h3>Vail Adapter</h3>
                <p>USB adapter that connects paddles to your computer for web-based CW</p>
            </div>

            <div class="selection-card" data-device="summit">
                <div class="card-icon">‚õ∞Ô∏è</div>
                <h3>Vail Summit</h3>
                <p>Standalone morse code trainer with built-in screen and keyboard</p>
            </div>
        </div>
    </section>

    <!-- Step 1.5: Adapter Model Selection (only shown for Adapter) -->
    <section id="step1_5" class="wizard-step">
        <h2>What model of Vail Adapter do you have?</h2>
        <p class="step-description">Choose the PCB version that matches your adapter.</p>

        <div class="card-grid">
            <div class="selection-card" data-model="basic_pcb">
                <div class="card-icon">üì¶</div>
                <h3>Basic PCB</h3>
                <p>Standard Vail Adapter PCB with paddle inputs and sidetone</p>
            </div>

            <div class="selection-card" data-model="advanced_pcb">
                <div class="card-icon">‚ö°</div>
                <h3>Advanced PCB</h3>
                <p>Includes radio output port and built-in capacitive touch points</p>
            </div>

            <div class="selection-card" data-model="non_pcb">
                <div class="card-icon">üîß</div>
                <h3>DIY No PCB</h3>
                <p>Hand-wired or breadboard build following GitHub specs</p>
            </div>
        </div>

        <button class="btn-secondary" id="backToStep1FromModel">‚Üê Back</button>
    </section>

    <!-- Step 2: Board Selection -->
    <section id="step2" class="wizard-step">
        <h2>Which Arduino board are you using?</h2>
        <p class="step-description">Select the microcontroller on your adapter.</p>

        <div class="card-grid">
            <div class="selection-card" data-board="qtpy">
                <div class="card-icon">üî∑</div>
                <h3>Adafruit QT Py SAMD21</h3>
                <p>Look for "QT Py" labeling on the board</p>
                <div class="hint" id="qtpyHint">üí° Most purchased Adapters will likely be a QT Py when in doubt</div>
            </div>

            <div class="selection-card" data-board="xiao">
                <div class="card-icon">üî∂</div>
                <h3>Seeeduino XIAO SAMD21</h3>
                <p>Look for "XIAO" labeling on the board</p>
            </div>
        </div>

        <button class="btn-secondary" id="backToStep1">‚Üê Back</button>
    </section>

    <!-- Step 3: Flash Adapter Firmware (UF2) -->
    <section id="step3" class="wizard-step">
        <h2>Flash Your Firmware</h2>
        <p class="step-description">You've selected: <strong id="selectedConfig"></strong></p>

        <!-- Sub-step 1: Plug In -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">1</span>
                <h3>Plug In Your Adapter</h3>
            </div>
            <p>Use a USB-C cable (must support data transfer) and connect your Vail Adapter to your computer.</p>
        </div>

        <!-- Sub-step 2: Enter Boot Mode -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">2</span>
                <h3>Enter Boot Mode</h3>
            </div>
            <p>Choose one of these methods to put your adapter into bootloader mode:</p>

            <div class="boot-methods">
                <div class="boot-method">
                    <h4>Method 1: WebSerial (Recommended)</h4>
                    <p>Click the button below to automatically trigger boot mode. Works in Chrome, Edge, and Opera browsers.</p>
                    <button id="bootModeButton" class="btn-primary">üîå Enter Boot Mode via WebSerial</button>
                    <div class="log-container">
                        <h4>Activity Log:</h4>
                        <pre id="serialLog"></pre>
                    </div>
                </div>

                <div class="boot-method">
                    <h4>Method 2: Manual Reset (Double-tap)</h4>
                    <p>Quickly double-tap the reset button on your adapter. The board should appear as a USB storage device (e.g., "QTPYBOOT" or "XIAOBOOT").</p>
                </div>
            </div>
        </div>

        <!-- Sub-step 3: Download Firmware -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">3</span>
                <h3>Download Firmware</h3>
            </div>
            <p>Download the firmware file for your configuration:</p>
            <a href="#" id="downloadButton" class="btn-download disabled" role="button" aria-disabled="true">
                <span class="download-icon">‚¨áÔ∏è</span>
                <span id="downloadText">Download UF2 File</span>
            </a>
        </div>

        <!-- Sub-step 4: Copy to Device -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">4</span>
                <h3>Copy Firmware to Device</h3>
            </div>
            <ol>
                <li>Open your file explorer (Finder on Mac, File Explorer on Windows)</li>
                <li>Find your Downloads folder and locate the downloaded .uf2 file</li>
                <li>Look for the adapter drive (named "QTPYBOOT", "XIAOBOOT", "ADAPTERBOOT", or similar)</li>
                <li>Drag and drop the .uf2 file onto the adapter drive</li>
                <li>Wait for the LED to stop flashing - the drive will automatically disconnect when complete</li>
            </ol>
        </div>

        <!-- Sub-step 5: Finalize -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">5</span>
                <h3>Finalize Setup</h3>
            </div>
            <ol>
                <li>Wait 10 seconds after the firmware copies</li>
                <li>Unplug and reconnect your Vail Adapter</li>
                <li><strong>Important:</strong> Visit <a href="https://vailmorse.com" target="_blank">vailmorse.com</a> (the official Vail web repeater) to configure your keyer type, speed, and tone settings</li>
                <li>Your settings will be saved to the device and can be used with any compatible CW application</li>
            </ol>
            <div class="success-message">
                <strong>‚úÖ You're all set!</strong> Your Vail Adapter is now running the latest firmware.
            </div>
        </div>

        <!-- Troubleshooting -->
        <div class="troubleshooting">
            <h3>‚ùì Troubleshooting</h3>
            <details>
                <summary>Device doesn't appear as storage drive</summary>
                <p>Try these steps:</p>
                <ul>
                    <li>Try the double-tap reset method instead of WebSerial</li>
                    <li>Use a different USB-C cable (some cables are charge-only)</li>
                    <li>Try a different USB port on your computer</li>
                    <li>Wait 5 seconds between taps when double-tapping the reset button</li>
                </ul>
            </details>

            <details>
                <summary>WebSerial button doesn't work</summary>
                <p>WebSerial requires Chrome, Edge, or Opera browser. If you're using Firefox or Safari, please switch browsers or use the manual reset method.</p>
            </details>

            <details>
                <summary>Linux: Permission denied</summary>
                <p>Add your user to the dialout group: <code>sudo usermod -a -G dialout $USER</code> then log out and back in.</p>
            </details>
        </div>

        <button class="btn-secondary" id="backToStep2">‚Üê Back</button>
        <button class="btn-primary" id="startOver">Start Over</button>
    </section>

    <!-- Step 4: Flash Summit Firmware (ESP32 Web Flasher) -->
    <section id="step4" class="wizard-step">
        <h2>Flash Vail Summit Firmware</h2>
        <p class="step-description">Web-based ESP32 flasher for the Vail Summit</p>

        <!-- Flash Instructions -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">1</span>
                <h3>Connect Your Device</h3>
            </div>
            <p>Make sure your Vail Summit is plugged in via USB.</p>
            <div class="info-box">
                <strong>Note:</strong> The flasher will automatically put the device into bootloader mode. If this fails, you may need to manually enter bootloader mode by holding BOOT and pressing RESET.
            </div>
        </div>

        <!-- ESP32 Flash Interface -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">2</span>
                <h3>Connect and Flash</h3>
            </div>
            <p>Click Connect below and select your device from the list (it may appear as "USB Serial Device" or similar).</p>

            <div id="espFlasherContainer">
                <button id="enterBootloaderButton" class="btn-primary">Step 1: Enter Bootloader Mode</button>
                <button id="connectButton" class="btn-primary" style="display: none;">Step 2: Connect in Bootloader Mode</button>
                <button id="disconnectButton" class="btn-secondary" style="display: none;">Disconnect</button>
                <button id="programButton" class="btn-download" style="display: none;">Flash Firmware</button>
                <button id="eraseButton" class="btn-secondary" style="display: none;">Erase Flash</button>

                <div class="progress-container" id="progressContainer" style="display: none; margin-top: 20px;">
                    <div class="progress-label" id="progressLabel">Preparing...</div>
                    <div style="background: #e0e0e0; border-radius: 8px; overflow: hidden; height: 24px;">
                        <div id="progressBar" style="background: linear-gradient(90deg, #4CAF50, #45a049); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="progressPercent" style="margin-top: 8px; font-size: 14px; color: #666;">0%</div>
                </div>

                <div class="log-container" style="margin-top: 20px;">
                    <h4>Flash Log:</h4>
                    <pre id="espFlashLog"></pre>
                </div>
            </div>
        </div>

        <!-- Finalize -->
        <div class="flash-step">
            <div class="step-header">
                <span class="step-badge">3</span>
                <h3>Complete!</h3>
            </div>
            <p>Once flashing is complete:</p>
            <ol>
                <li><strong>Unplug</strong> your Vail Summit from USB</li>
                <li><strong>Wait 2 seconds</strong></li>
                <li><strong>Plug it back in</strong> to power it on with the new firmware</li>
                <li>Follow the on-screen setup wizard to configure WiFi and preferences</li>
            </ol>
            <div class="success-message">
                <strong>‚úÖ You're all set!</strong> Your Vail Summit is ready for morse code training.
            </div>
        </div>

        <!-- Troubleshooting -->
        <div class="troubleshooting">
            <h3>‚ùì Troubleshooting</h3>
            <details>
                <summary>Browser doesn't support Web Serial</summary>
                <p>Web Serial API is required for ESP32 flashing. Please use Chrome, Edge, or Opera browser. Firefox and Safari are not currently supported.</p>
            </details>

            <details>
                <summary>Device not detected</summary>
                <p>Try these steps:</p>
                <ul>
                    <li>Make sure you're using a data-capable USB cable (not charge-only)</li>
                    <li>Try a different USB port on your computer</li>
                    <li>Check that the ESP32-S3 drivers are installed on your system</li>
                    <li>Try holding the BOOT button while plugging in the device</li>
                </ul>
            </details>

            <details>
                <summary>Flashing failed or stuck</summary>
                <p>If flashing fails:</p>
                <ul>
                    <li>Click "Erase Flash" and try again</li>
                    <li>Unplug the device, wait 5 seconds, and reconnect</li>
                    <li>Try holding the BOOT button during connection</li>
                </ul>
            </details>
        </div>

        <button class="btn-secondary" id="backToStep1FromSummit">‚Üê Back</button>
        <button class="btn-primary" id="startOverFromSummit">Start Over</button>
    </section>
</div>

<script src="esp-flasher.js" type="module"></script>
<script src="script.js" defer></script>
</body>
</html>
