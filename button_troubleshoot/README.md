# Button Hat Troubleshooting Tool

This folder contains a diagnostic tool for testing Vail Adapter button hat PCBs.

## Purpose

The button hat uses a resistor ladder network to read three buttons through a single analog pin. This tool helps diagnose issues by measuring the actual analog values produced by each button combination.

## Files

- `button_troubleshoot.ino` - Arduino sketch source code
- `button_test_qtpy.uf2` - Pre-compiled firmware for QT Py SAMD21 (drag-and-drop ready)
- `button_test_xiao.uf2` - Pre-compiled firmware for Seeeduino XIAO SAMD21 (drag-and-drop ready)
- `build_output/` - Compiled binary files for QT Py (generated by arduino-cli)
- `build_output_xiao/` - Compiled binary files for XIAO (generated by arduino-cli)

## How to Use

### 1. Flash the Firmware

**Option A: Drag-and-Drop (Easy)**

For **QT Py SAMD21**:
1. Connect your QT Py to USB while holding the BOOT button
2. A drive named `QTPY_BOOT` will appear
3. Drag `button_test_qtpy.uf2` onto the drive
4. The board will automatically reboot with the test firmware

For **Seeeduino XIAO SAMD21**:
1. Connect your XIAO to USB
2. Double-click the reset button to enter bootloader mode
3. A drive named `Arduino` will appear
4. Drag `button_test_xiao.uf2` onto the drive
5. The board will automatically reboot with the test firmware

**Option B: Build from Source**

For QT Py:
```bash
cd button_troubleshoot
arduino-cli compile --fqbn adafruit:samd:adafruit_qtpy_m0 --output-dir build_output --export-binaries .
python ../uf2conv.py -c -f 0x68ED2B88 -b 0x2000 build_output/button_troubleshoot.ino.bin -o button_test_qtpy.uf2
```

For XIAO:
```bash
cd button_troubleshoot
arduino-cli compile --fqbn Seeeduino:samd:seeed_XIAO_m0 --output-dir build_output_xiao --export-binaries .
python ../uf2conv.py -c -f 0x68ED2B88 -b 0x2000 build_output_xiao/button_troubleshoot.ino.bin -o button_test_xiao.uf2
```

### 2. Run the Test

1. Open your serial monitor (115200 baud)
   - Arduino IDE: Tools > Serial Monitor
   - PlatformIO: Monitor task
   - Command line: `screen /dev/ttyACM0 115200` (Linux/Mac) or PuTTY (Windows)

2. The tool will display instructions and expected value ranges

3. Follow the prompts:
   - Test 1: Release all buttons, press Enter
   - Test 2: Hold Button 3, press Enter
   - Test 3: Hold Button 2, press Enter
   - Test 4: Hold Button 1, press Enter
   - Test 5: Hold Buttons 2+3 together, press Enter
   - Test 6: Hold Buttons 1+3 together, press Enter
   - Test 7: Hold Buttons 1+2 together, press Enter

4. Review the results summary

### 3. Interpret Results

The tool measures each button combination 50 times and reports:
- **Min/Max**: Range of values (larger range = noisy connections)
- **Avg**: Average value (should be within expected range)
- **Status**: `GOOD` if within expected range, `CHECK` if outside

#### Expected Values for Advanced PCB

| Button State | Expected Range | Typical Value |
|--------------|----------------|---------------|
| None         | 0-100          | 0             |
| B3           | 260-300        | 280           |
| B2           | 315-355        | 335           |
| B2+B3        | 377-405        | 397           |
| B1           | 406-435        | 414           |
| B1+B3        | 470-502        | 490           |
| B1+B2        | 503-650        | 516           |

**Note:** V2 Basic PCB has different expected values. See `buttons.cpp` lines 156-189 for V2 ranges.

### 4. Common Issues

**Values Outside Expected Range:**
- Wrong resistor values in the ladder network
- Poor solder joints on resistors or buttons
- Damaged components
- Incorrect PCB version (check if you have Advanced vs V2 Basic)

**Large Range (Max - Min > 20):**
- Noisy connections
- Intermittent contact in buttons
- Loose wires or connectors

**Overlapping Values Between Buttons:**
- Will cause unreliable button detection in normal operation
- Check resistor values and solder joints
- Verify correct resistor placement per schematic

**All Values Near Zero:**
- Button pin not connected to resistor ladder
- Short circuit to ground
- Wrong pin configuration

**All Values Near 1023:**
- Open circuit (no connection to button network)
- Missing pull-down resistor
- Broken trace on PCB

## Restoring Normal Firmware

After testing, flash the normal Vail Adapter firmware:

**For QT Py:**
```bash
# Copy the appropriate UF2 from docs/firmware_files/
# For QT Py Advanced PCB:
cp docs/firmware_files/qtpy_advanced_pcb.uf2 /media/QTPY_BOOT/
```

**For XIAO:**
```bash
# Copy the appropriate UF2 from docs/firmware_files/
# For XIAO Advanced PCB:
cp docs/firmware_files/xiao_advanced_pcb.uf2 /media/Arduino/
```

Or use the web updater at https://vailadapter.com

## Technical Details

- **Sampling**: 50 readings per button, 10ms between samples
- **Pin**: Digital pin 3 (A3 analog input on both QT Py and XIAO SAMD21)
- **Resolution**: 10-bit ADC (0-1023 range)
- **Averaging**: Reduces noise from electrical interference
- **Compatibility**: Works with all Vail Adapter PCB versions (same button pin configuration)

## Support

If you get unexpected results:
1. Save the test output
2. Take photos of your button hat PCB (both sides)
3. Report issue with results and photos to Vail Adapter support
